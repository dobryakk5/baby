# main.py
"""
–ì–ª–∞–≤–Ω—ã–π —Ñ–∞–π–ª –±–æ—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Excel –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
"""

from fertility_tracker import *  # –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –≤—Å–µ –∏–∑ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Ñ–∞–π–ª–∞ –±–æ—Ç–∞
from fertility_excel_bot_integration import register_excel_handlers
from fertility_chart_bot_integration import register_chart_handlers

# –û–±–Ω–æ–≤–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –Ω–æ–≤—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
def get_main_keyboard_with_excel():
    builder = ReplyKeyboardBuilder()
    builder.button(text="üå° –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É")
    builder.button(text="üíß –í—ã–¥–µ–ª–µ–Ω–∏—è")
    builder.button(text="üîπ –®–µ–π–∫–∞ –º–∞—Ç–∫–∏")
    builder.button(text="‚ö†Ô∏è –ù–∞—Ä—É—à–µ–Ω–∏—è")
    builder.button(text="üìù –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É")
    builder.button(text="üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö")
    builder.button(text="üìà –ú–æ–π –≥—Ä–∞—Ñ–∏–∫")  # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∏
    builder.button(text="üìä Excel –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç")  # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
    builder.button(text="üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel")  # –ù–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞
    builder.button(text="üîÑ –ù–æ–≤—ã–π —Ü–∏–∫–ª")
    builder.button(text="‚ÑπÔ∏è –ü–æ–º–æ—â—å")
    builder.adjust(2)
    return builder.as_markup(resize_keyboard=True)

# –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–ª—É—á–µ–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
get_main_keyboard = get_main_keyboard_with_excel

# –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@dp.message(CommandStart())
async def command_start_handler_updated(message: Message):
    try:
        user_id = message.from_user.id
        username = message.from_user.username
        first_name = message.from_user.first_name
        last_name = message.from_user.last_name
        
        # –°–æ–∑–¥–∞–Ω–∏–µ –∏–ª–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        await db.create_user(user_id, username, first_name, last_name)
        
        welcome_text = (
            f"–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, {message.from_user.full_name}! üëã\n\n"
            "–Ø –≤–∞—à –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—é —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–º–ø—Ç–æ—Ç–µ—Ä–º–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞.\n\n"
            "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å:\n"
            "üîπ –ë–∞–∑–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞ (–ë–¢–¢)\n"
            "üîπ –í—ã–¥–µ–ª–µ–Ω–∏—è\n"
            "üîπ –ü–æ–ª–æ–∂–µ–Ω–∏–µ —à–µ–π–∫–∏ –º–∞—Ç–∫–∏\n"
            "üîπ –î—Ä—É–≥–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è\n\n"
            "‚ú® <b>–ù–æ–≤—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:</b>\n"
            "üìà –ì—Ä–∞—Ñ–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ñ–∞–∑\n"
            "üìä –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –∏–∑ Excel —Ñ–∞–π–ª–æ–≤\n"
            "üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö –≤ Excel\n"
            "üîÆ –ü—Ä–æ–≥–Ω–æ–∑—ã —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏\n"
            "üìÑ –°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\n\n"
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –Ω–∏–∂–µ –∏–ª–∏ /help –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–æ–º–∞–Ω–¥."
        )
        await message.answer(welcome_text, reply_markup=get_main_keyboard(), parse_mode="HTML")
    except TelegramForbiddenError:
        logging.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ start: {e}")

# –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /help
@dp.message(Command("help"))
async def command_help_handler_updated(message: Message):
    try:
        help_text = (
            "–Ø –º–æ–≥—É –ø–æ–º–æ—á—å –≤–∞–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –æ —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —Å–∏–º–ø—Ç–æ—Ç–µ—Ä–º–∞–ª—å–Ω–æ–≥–æ –º–µ—Ç–æ–¥–∞.\n\n"
            "<b>–û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "üå° –î–æ–±–∞–≤–∏—Ç—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É - –ó–∞–ø–∏—Å–∞—Ç—å —É—Ç—Ä–µ–Ω–Ω—é—é –±–∞–∑–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É —Ç–µ–ª–∞\n"
            "üíß –í—ã–¥–µ–ª–µ–Ω–∏—è - –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏—è –∏ –º–µ–Ω—Å—Ç—Ä—É–∞—Ü–∏—é\n"
            "üîπ –®–µ–π–∫–∞ –º–∞—Ç–∫–∏ - –ó–∞–ø–∏—Å–∞—Ç—å –ø–æ–ª–æ–∂–µ–Ω–∏–µ —à–µ–π–∫–∏ –º–∞—Ç–∫–∏\n"
            "üìù –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É - –î–æ–±–∞–≤–∏—Ç—å –¥—Ä—É–≥–∏–µ –Ω–∞–±–ª—é–¥–µ–Ω–∏—è\n"
            "üìä –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–∞–Ω–Ω—ã—Ö - –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞\n\n"
            "<b>–ì—Ä–∞—Ñ–∏–∫–∏ –∏ –∞–Ω–∞–ª–∏–∑:</b>\n"
            "üìà –ú–æ–π –≥—Ä–∞—Ñ–∏–∫ - –ì—Ä–∞—Ñ–∏–∫–∏ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Å –∞–Ω–∞–ª–∏–∑–æ–º —Ñ–∞–∑\n"
            "üîÆ –ü—Ä–æ–≥–Ω–æ–∑ —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ - –ê–Ω–∞–ª–∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Ü–∏–∫–ª–∞\n"
            "üìÖ –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–π —Ñ–∞–∑—ã —Ü–∏–∫–ª–∞\n"
            "‚≠ê –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ –æ–≤—É–ª—è—Ü–∏–∏\n\n"
            "<b>Excel –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è:</b>\n"
            "üìä Excel –∏–º–ø–æ—Ä—Ç/—ç–∫—Å–ø–æ—Ä—Ç - –†–∞–±–æ—Ç–∞ —Å Excel —Ñ–∞–π–ª–∞–º–∏\n"
            "üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel - –°–∫–∞—á–∞—Ç—å –≤–∞—à–∏ –¥–∞–Ω–Ω—ã–µ –≤ Excel\n"
            "üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel - –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Excel —Ñ–∞–π–ª–∞\n"
            "üìÑ –®–∞–±–ª–æ–Ω Excel - –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è\n\n"
            "<b>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:</b>\n"
            "üîÑ –ù–æ–≤—ã–π —Ü–∏–∫–ª - –ù–∞—á–∞—Ç—å –Ω–æ–≤—ã–π —Ü–∏–∫–ª\n"
            "‚ÑπÔ∏è –ü–æ–º–æ—â—å - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É\n\n"
            "<b>–°–∏–º–ø—Ç–æ—Ç–µ—Ä–º–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥</b> –ø–æ–º–æ–≥–∞–µ—Ç –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –≤–∞—à–µ —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—É—Ç–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è:\n"
            "1. –ë–∞–∑–∞–ª—å–Ω–æ–π —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã —Ç–µ–ª–∞ (–∏–∑–º–µ—Ä—è–µ—Ç—Å—è –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ)\n"
            "2. –ù–∞–±–ª—é–¥–µ–Ω–∏–π –∑–∞ —Ü–µ—Ä–≤–∏–∫–∞–ª—å–Ω–æ–π —Å–ª–∏–∑—å—é\n"
            "3. –ü–æ–ª–æ–∂–µ–Ω–∏—è —à–µ–π–∫–∏ –º–∞—Ç–∫–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)\n\n"
            "<b>Excel –∏–º–ø–æ—Ä—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:</b>\n"
            "‚Ä¢ –î–µ–Ω—å —Ü–∏–∫–ª–∞\n"
            "‚Ä¢ –î–∞—Ç–∞ –∑–∞–ø–∏—Å–∏\n"
            "‚Ä¢ –ë–¢–¢ (–±–∞–∑–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Ç–µ–ª–∞)\n"
            "‚Ä¢ –ù–∞—Ä—É—à–µ–Ω–∏—è –∏–∑–º–µ—Ä–µ–Ω–∏—è\n"
            "‚Ä¢ –í—Ä–µ–º—è –∏–∑–º–µ—Ä–µ–Ω–∏—è\n"
            "‚Ä¢ –ü—Ä–∏–º–µ—á–∞–Ω–∏—è –∏ –∑–∞–º–µ—Ç–∫–∏"
        )
        await message.answer(help_text, reply_markup=get_main_keyboard(), parse_mode="HTML")
    except TelegramForbiddenError:
        logging.warning(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {message.from_user.id} –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –±–æ—Ç–∞")
    except Exception as e:
        logging.error(f"–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ help: {e}")

# –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
def register_all_handlers():
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤, –≤–∫–ª—é—á–∞—è Excel —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∏"""
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Excel –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    register_excel_handlers(dp)
    
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
    register_chart_handlers(dp)
    
    logging.info("–í—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã, –≤–∫–ª—é—á–∞—è Excel —Ñ—É–Ω–∫—Ü–∏–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–∏")

# –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è main
async def main_updated():
    # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –≤—Å–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
    register_all_handlers()
    
    # –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ –∑–∞–ø—É—Å–∫–∞ –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
    dp.startup.register(on_startup)
    dp.shutdown.register(on_shutdown)
    
    logging.info("–ó–∞–ø—É—Å–∫ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ñ–µ—Ä—Ç–∏–ª—å–Ω–æ—Å—Ç–∏ —Å Excel –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏ –≥—Ä–∞—Ñ–∏–∫–∞–º–∏...")
    try:
        await dp.start_polling(bot)
    except TelegramForbiddenError as e:
        logging.error(f"–ë–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º: {e}")
    except Exception:
        logging.exception("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–ø—Ä–æ—Å–µ")

if __name__ == "__main__":
    try:
        asyncio.run(main_updated())
    except KeyboardInterrupt:
        logging.info("–ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception:
        logging.exception("–ù–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞")